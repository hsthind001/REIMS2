input {
  # File input for REIMS2 logs
  file {
    path => "/var/log/reims2/*.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb"
    codec => "json"
    type => "reims2"
  }
  
  # TCP input for direct log streaming (optional)
  tcp {
    port => 5044
    codec => json_lines
    type => "reims2"
  }
}

filter {
  # Parse JSON logs
  if [type] == "reims2" {
    # Logs are already in JSON format, but ensure proper parsing
    json {
      source => "message"
      target => "parsed"
    }
    
    # Extract fields from parsed JSON
    if [parsed] {
      mutate {
        add_field => {
          "correlation_id" => "%{[parsed][correlation_id]}"
          "user_id" => "%{[parsed][user_id]}"
          "query_id" => "%{[parsed][query_id]}"
          "conversation_id" => "%{[parsed][conversation_id]}"
          "level" => "%{[parsed][level]}"
          "message" => "%{[parsed][message]}"
          "timestamp" => "%{[parsed][timestamp]}"
        }
      }
    }
    
    # Parse timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
    
    # Add service name
    mutate {
      add_field => { "service" => "reims2-backend" }
    }
    
    # Add environment
    mutate {
      add_field => { "environment" => "${ENVIRONMENT:production}" }
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "reims2-logs-%{+YYYY.MM.dd}"
    template_name => "reims2-logs"
    template => "/usr/share/logstash/templates/reims2-template.json"
    template_overwrite => true
  }
  
  # Debug output (optional, remove in production)
  # stdout {
  #   codec => rubydebug
  # }
}

